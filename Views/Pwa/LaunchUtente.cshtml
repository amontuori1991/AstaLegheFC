@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <!-- aggiungi viewport-fit -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Avvio…</title>

    <!-- PWA -->
    <meta name="theme-color" content="#2c3e50" />
    <link rel="manifest" href="/pwa/manifest-utente">

    <!-- iOS A2HS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fantabazzer">
    <link rel="apple-touch-icon" href="/images/icons/icon-192x192.png">

    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            padding-top: calc(var(--safe-top));
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2c3e50;
            color: #ecf0f1;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
        }

        .box {
            max-width: 420px;
            width: 92%
        }

        .fld {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #34495e;
            background: #1f2a39;
            color: #fff
        }

        .btn {
            padding: 10px 14px;
            border-radius: 8px;
            border: 0;
            background: #3498db;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .stack {
            display: flex;
            flex-direction: column;
            gap: 10px
        }
    </style>
</head>
<body>
    <div id="app" class="box">Avvio asta…</div>

    <script>
        // chiavi unificate
        const KEY_URL='fb:lastUtenteUrl', KEY_LEGA='fb:lega', KEY_NICK='fb:nick';

        function buildUrl(lega,nick){ return `/Utente?lega=${encodeURIComponent(lega)}&nick=${encodeURIComponent(nick)}`; }

        // cookie helper (fallback)
        function setCookie(name,value,days){
          const maxAge = days ? `; max-age=${days*24*60*60}` : '';
          document.cookie = `${name}=${encodeURIComponent(value)}; path=/${maxAge}`;
        }
        function getCookie(name){
          const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-./*+?^${}()|[\\]\\\\]/g,'\\$&') + '=([^;]*)'));
          return m ? decodeURIComponent(m[1]) : null;
        }

        function saveAll(lega,nick){
          try{ localStorage.setItem(KEY_LEGA,lega); localStorage.setItem(KEY_NICK,nick); localStorage.setItem(KEY_URL, buildUrl(lega,nick)); }catch{}
          setCookie('pwa_lega',lega,365); setCookie('pwa_nick',nick,365);
        }

        (function(){
          try{
            // 1) Query: salva e vai
            const u = new URL(location.href);
            const qL = u.searchParams.get('lega');
            const qN = u.searchParams.get('nick');
            if (qL && qN){ saveAll(qL,qN); location.replace(buildUrl(qL,qN)); return; }

            // 2) URL completo salvato
            const last = localStorage.getItem(KEY_URL);
            if (last) { location.replace(last); return; }

            // 3) alias/nick salvati (LS o cookie)
            const l = localStorage.getItem(KEY_LEGA) || getCookie('pwa_lega');
            const n = localStorage.getItem(KEY_NICK) || getCookie('pwa_nick');
            if (l && n){ saveAll(l,n); location.replace(buildUrl(l,n)); return; }

            // 4) Fallback: form (precompila se trovi cookie/LS)
            document.getElementById('app').innerHTML = `
              <div class="stack">
                <h2>Completa i dati</h2>
                <input id="lega" class="fld" placeholder="Alias lega" autocomplete="off" value="${l||''}" />
                <input id="nick" class="fld" placeholder="Nickname" autocomplete="off" value="${n||''}" />
                <button id="go" class="btn">Entra</button>
              </div>`;
            const go = ()=> {
              const L = document.getElementById('lega').value.trim();
              const N = document.getElementById('nick').value.trim();
              if(!L||!N){ alert('Inserisci lega e nick'); return; }
              saveAll(L,N);
              location.assign(buildUrl(L,N));
            };
            document.getElementById('go').onclick = go;
            document.getElementById('lega').addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
            document.getElementById('nick').addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
          }catch(e){
            console.error(e);
            document.getElementById('app').textContent='Errore di avvio. Apri dal browser e aggiungi di nuovo alla Home.';
          }
        })();
    </script>
</body>
</html>
